<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <title>Nyabultangkis ‚Äì Vote Lapangan</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --n: #00ff88;
            --a: #ff6a00;
            --bg: #111;
            --card: #1a1a1a;
            --text: #f2f2f2;
            --r: 10px
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Poppins, system-ui
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 16px;
            font-size: 14px
        }

        h1,
        h2 {
            color: var(--n);
            margin-bottom: 12px
        }

        button {
            cursor: pointer;
            border: none;
            font-weight: 700;
            border-radius: var(--r)
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--n);
            color: #000;
            transition: .3s
        }

        .btn:hover {
            background: #fff
        }

        .btn:disabled {
            background: #555;
            color: #888
        }

        .btn-second {
            background: var(--a);
            color: #fff;
            margin-top: 8px
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            margin-top: 6px;
            border: none;
            border-radius: var(--r);
            background: #222;
            color: var(--text)
        }

        textarea {
            resize: vertical;
            min-height: 60px
        }

        .card {
            background: var(--card);
            padding: 16px;
            margin-bottom: 16px;
            border-radius: var(--r);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .4)
        }

        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px
        }

        .col {
            flex: 1
        }

        .small {
            font-size: .8rem;
            opacity: .7
        }

        .lapang-list,
        .waktu-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px
        }

        .pill {
            background: #222;
            border: 2px solid var(--n);
            color: var(--n);
            padding: 8px 12px;
            border-radius: var(--r);
            font-size: 13px
        }

        .pill.sel {
            background: var(--n);
            color: #000
        }

        .import-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: var(--a);
            color: #fff;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 20px
        }
    </style>
</head>

<body>
    <h1>üè∏ Nyabultangkis</h1>

    <!-- LOGIN -->
    <div id="loginPage" class="card">
        <label>Username
            <input id="username" type="text" placeholder="got">
        </label>
        <label>Password (3 angka berurutan)
            <input id="password" type="password" placeholder="567">
        </label>
        <button class="btn" onclick="login()">Login</button>
    </div>

    <!-- APP -->
    <div id="appPage" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 id="pageTitle">Event</h2>
            <button class="btn btn-second" onclick="logout()">Logout</button>
        </div>

        <!-- FORM BUAT EVENT (khusus got) -->
        <div id="adminForm" class="card" style="display:none">
            <h3>Buat Event</h3>
            <label>Nama Acara<input id="title" required></label>
            <label>Tanggal<input type="date" id="tanggal" required></label>
            <label>Lapang (satu per baris)<textarea id="places" rows="2">Lapangan A
Lapangan B</textarea></label>
            <label>Waktu (satu per baris, 19:00)<textarea id="times" rows="2">19:00
20:00</textarea></label>
            <button class="btn" onclick="buatEvent()">Buat Event</button>
        </div>

        <!-- DAFTAR EVENT -->
        <div id="eventList"></div>
    </div>

    <!-- TOMBOL IMPORT DATA (sekali saja) -->
    <button class="import-btn" onclick="importData()">Import User</button>

    <!-- FIREBASE -->
    <script type="module">
        // ========= GANTI INI DENGAN CONFIG MILIKMU =========
   const firebaseConfig = {
  apiKey: "AIzaSyCJAJR8ODqVXRwUjsIgC1b_Yvdyw6eyJr8",
  authDomain: "bulutangkis-ca92b.firebaseapp.com",
  projectId: "bulutangkis-ca92b",
  storageBucket: "bulutangkis-ca92b.firebasestorage.app",
  messagingSenderId: "1008111745548",
  appId: "1:1008111745548:web:4a1f852caac9a2356a0c29",
  measurementId: "G-B1CK8E3FY0"
};
    // ====================================================

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, doc, getDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Email dummy generator
    function toEmail(username) {
      return `${username}@nyabultangkis.web.app`;
    }

    window.importData = async () => {
    const list = [
        { nama: 'goy',  username: 'goy',  pass: '123456' },
        { nama: 'gungun', username: 'gungun', pass: '234567' },
        { nama: 'adit', username: 'adit', pass: '345678' },
        { nama: 'rere', username: 'rere', pass: '456789' },
        { nama: 'mitha', username: 'mitha', pass: '567890' },
        { nama: 'putri', username: 'putri', pass: '678901' },
        { nama: 'yor', username: 'yor', pass: '789012' },
        { nama: 'uji', username: 'uji', pass: '890123' },
        { nama: 'got',  username: 'got',  pass: '901234' },
        { nama: 'amat', username: 'amat', pass: '012345' }
    ];
      for (const u of list) {
        try {
          const email = toEmail(u.username);
          const cred = await createUserWithEmailAndPassword(auth, email, u.pass);
          await setDoc(doc(db, 'users', cred.user.uid), { nama: u.nama, username: u.username });
          if (u.nama === 'got') await setDoc(doc(db, 'admins', cred.user.uid), {});
        } catch (e) { console.log(e.message); }
      }
      alert('Import selesai! (lihat Firestore)');
    };

    window.login = async () => {
      const username = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      if (!username || !pass) return alert('Lengkapi form');
      try {
        const email = toEmail(username);
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        alert('Login gagal: ' + e.message);
      }
    };
    window.logout = () => signOut(auth);

    let userId = null; let isAdmin = false;
    onAuthStateChanged(auth, async u => {
      if (!u) {
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('appPage').style.display = 'none';
        return;
      }
      userId = u.uid;
      const adm = await getDoc(doc(db, 'admins', userId));
      isAdmin = adm.exists;
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('appPage').style.display = 'block';
      document.getElementById('adminForm').style.display = isAdmin ? 'block' : 'none';
      loadEvents();
    });

    window.buatEvent = async () => {
      const title = document.getElementById('title').value.trim();
      const tgl = document.getElementById('tanggal').value;
      const places = document.getElementById('places').value.split('\n').map(x => x.trim()).filter(x => x);
      const times = document.getElementById('times').value.split('\n').map(x => x.trim()).filter(x => x);
      if (!title || !tgl || !places.length || !times.length) return alert('Lengkapi form');
      const deadline = new Date(Date.now() + 60 * 60 * 1000); // 1 jam
      const evRef = await addDoc(collection(db, 'events'), {
        title, tanggal: tgl,
        status: 'polling',
        deadline: Timestamp.fromDate(deadline),
        createdBy: userId,
        createdAt: serverTimestamp()
      });
      const pollCol = collection(db, 'events', evRef.id, 'polls');
      const batch = [];
      places.forEach(v => batch.push({ type: 'place', value: v, votes: 0 }));
      times.forEach(v => batch.push({ type: 'time', value: v, votes: 0 }));
      await Promise.all(batch.map(d => addDoc(pollCol, d)));
      alert('Event dibuat!');
      document.getElementById('title').value = '';
      document.getElementById('tanggal').value = '';
    };

    function loadEvents() {
      const q = query(collection(db, 'events'), where('status', '==', 'polling'));
      onSnapshot(q, snap => {
        const box = document.getElementById('eventList');
        box.innerHTML = '';
        snap.forEach(d => renderEvent(d));
        if (snap.empty) box.innerHTML = '<div class="small">Belum ada event.</div>';
      });
    }

    async function renderEvent(docSnap) {
      const ev = docSnap.data();
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${ev.title}</h3><div class="small">Tanggal: ${ev.tanggal}</div><div class="small">Deadline: ${ev.deadline.toDate().toLocaleString()}</div>`;

      const voteSnap = doc(db, 'events', docSnap.id, 'votes', userId);
      const vs = await getDoc(voteSnap);
      const sudah = vs.exists;
      const pilihanku = vs.data() || {};

      const pollCol = collection(db, 'events', docSnap.id, 'polls');
      onSnapshot(pollCol, qs => {
        const placeGroup = document.createElement('div');
        placeGroup.innerHTML = '<div class="small">Pilih Lapang:</div>';
        const timeGroup = document.createElement('div');
        timeGroup.innerHTML = '<div class="small">Pilih Waktu:</div>';
        qs.forEach(p => {
          const data = p.data();
          const isPil = (pilihanku.placeId === p.id) || (pilihanku.timeId === p.id);
          const span = document.createElement('span');
          span.className = 'pill ' + (isPil ? 'sel' : '');
          span.textContent = `${data.value} (${data.votes || 0})`;
          if (!sudah) {
            span.style.cursor = 'pointer';
            span.onclick = async () => {
              if (data.type === 'place') await setDoc(voteSnap, { ...pilihanku, placeId: p.id }, { merge: true });
              if (data.type === 'time') await setDoc(voteSnap, { ...pilihanku, timeId: p.id }, { merge: true });
            };
          }
          if (data.type === 'place') placeGroup.appendChild(span);
          if (data.type === 'time') timeGroup.appendChild(span);
        });
        card.appendChild(placeGroup);
        card.appendChild(timeGroup);
        if (sudah) card.insertAdjacentHTML('beforeend', '<div class="small">Kamu sudah memilih ‚úî</div>');
      });

      document.getElementById('eventList').appendChild(card);
    }
  </script>
</body>

</html>